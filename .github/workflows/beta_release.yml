name: Beta Release builds

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  changelog:
    name: Beta Release Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create or update beta tag
        uses: ovsds/create-or-update-ref-action@v1
        with:
          ref: tags/beta
          sha: ${{ github.sha }}

      - name: Delete local beta tag
        run: git tag -d beta
        continue-on-error: true

      - name: Generate changelog
        run: |
          git tag -l
          npx changelogithub --output CHANGELOG.md

      - name: Upload changelog to beta release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: beta
          prerelease: true
          body_path: CHANGELOG.md
          files: CHANGELOG.md

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: beta-changelog
          path: CHANGELOG.md
          compression-level: 0
          if-no-files-found: error

  release:
    needs: changelog
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - target: "linux-arm64-musl"
            hash: "md5-linux-musl-arm64"

    name: Beta Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.0"

      # =================================================
      # 自动识别前端最新 Release 版本
      # =================================================
      - name: Detect latest frontend release
        id: frontend
        run: |
          FRONTEND_REPO="yourname/OpenList-Frontend"

          TAG=$(curl -fsSL \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/$FRONTEND_REPO/releases/latest \
            | jq -r '.tag_name')

          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "❌ Failed to detect latest frontend release"
            exit 1
          fi

          echo "✅ Detected frontend version: $TAG"
          echo "FRONTEND_VERSION=$TAG" >> $GITHUB_ENV
          echo "FRONTEND_REPO=$FRONTEND_REPO" >> $GITHUB_ENV

      # =================================================
      # 使用自动识别到的前端版本
      # =================================================
      - name: Setup web (auto frontend version)
        run: bash build.sh dev web
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build
        uses: OpenListTeam/cgo-actions@v1.2.2
        with:
          targets: ${{ matrix.target }}
          musl-target-format: $os-$musl-$arch
          github-token: ${{ secrets.GITHUB_TOKEN }}
          out-dir: build
          output: openlist-$target$ext
          musl-base-url: "https://github.com/OpenListTeam/musl-compilers/releases/latest/download/"
          x-flags: |
            github.com/OpenListTeam/OpenList/v4/internal/conf.BuiltAt=$built_at
            github.com/OpenListTeam/OpenList/v4/internal/conf.GitAuthor=The OpenList Projects Contributors <noreply@openlist.team>
            github.com/OpenListTeam/OpenList/v4/internal/conf.GitCommit=$git_commit
            github.com/OpenListTeam/OpenList/v4/internal/conf.Version=$tag
            github.com/OpenListTeam/OpenList/v4/internal/conf.WebVersion=$FRONTEND_VERSION

      - name: Compress
        run: bash build.sh zip ${{ matrix.hash }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload assets to beta release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: beta
          prerelease: true
          files: build/compress/*

      - name: Clean target name
        run: |
          CLEANED=$(echo "${{ matrix.target }}" | sed -E 's/[":<>|*?\\/\r\n]//g')
          echo "CLEANED_TARGET=$CLEANED" >> $GITHUB_ENV

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: beta-build-${{ env.CLEANED_TARGET }}
          path: build/compress/*
          compression-level: 0
          if-no-files-found: error
