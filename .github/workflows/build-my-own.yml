name: Build All Platforms

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: '后端版本号 (如 v4.1.8)'
        required: true
        default: 'v4.1.9'
      build_lite:
        description: '是否使用 Lite 版前端'
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Backend
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Build All Binaries
        env:
          FRONTEND_REPO: "UNI-earth/OpenList-Frontend"
          # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 如果前端仓库私有则开启
          VERSION: ${{ github.event.inputs.version_tag }}
        run: |
          chmod +x build.sh
          
          # 定义基础命令
          # 根据你的 build.sh 逻辑，'release' 参数会触发全平台构建循环
          BUILD_CMD="./build.sh release"
          
          if [ "${{ github.event.inputs.build_lite }}" = "true" ]; then
            BUILD_CMD="$BUILD_CMD lite"
          fi
          
          echo "正在为所有平台编译版本: $VERSION ..."
          $BUILD_CMD

      - name: Upload All Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OpenList-Full-Release-${{ github.event.inputs.version_tag }}
          # build.sh 会把所有编译好的压缩包和二进制文件放在 bin/release 目录下
          path: bin/release/*
